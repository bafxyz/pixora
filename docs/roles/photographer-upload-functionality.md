# Функционал загрузки фотографий для роли Фотограф

## Анализ функционала загрузки фотографий

### ✅ **Что работает правильно:**

#### 1. **Компонент PhotoUpload** (`apps/web/src/features/photographer/components/photo-upload.tsx`)
- Drag & drop интерфейс для выбора фотографий
- Предпросмотр выбранных фото
- Загрузка в Supabase Storage в папку `photos/{guestId}/`
- Визуальная индикация прогресса загрузки
- Обработка ошибок
- Поддержка множественного выбора файлов
- Валидация форматов (JPG, PNG, WebP)

#### 2. **API endpoint** (`apps/web/src/app/api/photos/save/route.ts`)
- Проверка ролей (photographer, studio-admin, admin)
- Валидация данных через Zod схему
- Поддержка привязки к `guestId` или `photoSessionId`
- Автоматическое добавление срока хранения фото (14 дней по умолчанию, настраивается через PHOTO_EXPIRATION_DAYS)
- Транзакционное сохранение в БД для атомарности операций
- Проверка доступа к ресурсам клиента (multi-tenancy)

#### 3. **Интеграция с Supabase Storage**
- Корректное создание клиента Supabase
- Загрузка файлов в Storage bucket "photos"
- Получение публичных URL для доступа к фото
- Настройка cache-control для оптимизации производительности

## Workflow загрузки фотографий

### Шаги процесса:
1. **Выбор файлов**
   - Фотограф выбирает файлы через drag & drop или кнопку выбора
   - Система показывает превью всех выбранных фото

2. **Идентификация получателя**
   - Вводит Guest ID (формат: GUEST123)
   - ИЛИ выбирает Photo Session из списка

3. **Загрузка в облако**
   - Файлы загружаются в Supabase Storage
   - Прогресс отображается для каждого файла
   - Неудачные загрузки помечаются красным

4. **Сохранение в БД**
   - URL загруженных фото сохраняются в базу данных
   - Привязываются к гостю или фотосессии
   - Устанавливается срок хранения

5. **Подтверждение**
   - Клиент получает уведомление об успешной загрузке
   - Показывается количество загруженных фото

## Поддерживаемые режимы работы

### 1. **По Guest ID** (legacy)
- Старый метод для обратной совместимости
- Прямая привязка фото к конкретному гостю
- Используется поле `guestId` в базе данных

### 2. **По Photo Session ID** (рекомендуется)
- Новый рекомендуемый метод
- Привязка фото к фотосессии
- Позволяет группировать фото по событиям
- Используется поле `photoSessionId` в базе данных

## Структура данных в БД

### Модель Photo в Prisma:
```prisma
model Photo {
  id             String    @id @default(uuid())
  photographerId String    // ID фотографа
  guestId        String?   // ID гостя (опционально)
  clientId       String    // ID клиента (студии)
  photoSessionId String?   // ID фотосессии (опционально)
  filePath       String    // Путь к файлу в Storage
  fileName       String    // Имя файла
  fileSize       Int?      // Размер файла
  isSelected     Boolean   @default(false) // Отображать ли клиенту
  expiresAt      DateTime? // Дата автоудаления
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}
```

## Безопасность

### Проверки доступа:
- **Проверка ролей** - только photographer, studio-admin, admin могут загружать
- **Валидация client_id** - для изоляции данных между студиями
- **Проверка доступа к ресурсам** - фотограф может загружать только для своих клиентов
- **Автоматическое удаление** - устаревшие фото удаляются по расписанию

### Валидация данных:
```typescript
const SavePhotosSchema = z.object({
  guestId: z.string().optional(),
  photoSessionId: z.string().optional(),
  photoUrls: z.array(z.string().url()).min(1)
}).refine(data => data.guestId || data.photoSessionId)
```

## Интерфейс фотографа

### PhotographerDashboard содержит:
- **Вкладка "Загрузка"** - основной интерфейс для загрузки фото
- **Превью галереи гостя** - просмотр как клиент видит свои фото
- **Вкладка "Заказы"** - просмотр заказов клиентов
- **Вкладка "Настройки"** - настройка брендинга галереи

### Компонент PhotoUpload предоставляет:
- Drag & drop зону для файлов
- Множественный выбор файлов
- Превью с возможностью удаления
- Индикация статуса загрузки
- Обработка ошибок с уведомлениями

## Технические детали

### Ограничения:
- Максимальный размер файла: 10MB
- Поддерживаемые форматы: JPG, PNG, WebP
- Срок хранения по умолчанию: 14 дней

### Конфигурация:
- `PHOTO_EXPIRATION_DAYS` - настройка срока хранения фото
- `NEXT_PUBLIC_SUPABASE_URL` - URL Supabase проекта
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - публичный ключ Supabase

## Статус функционала

**✅ ПОЛНОСТЬЮ РАБОЧИЙ И ГОТОВ К ИСПОЛЬЗОВАНИЮ**

Функционал загрузки фотографий полностью реализован, протестирован и готов к продакшену. Поддерживает как старый workflow через Guest ID, так и новый через Photo Sessions.